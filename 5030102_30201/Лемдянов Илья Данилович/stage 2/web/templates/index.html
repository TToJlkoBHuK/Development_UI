<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Robot Miner Web</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>ü§ñ Robot Miner</h1>

        <div class="main">
            <div class="map-section">
                <div class="upload-area">
                    <input type="file" id="mapFile" accept=".txt">
                    <div class="upload-hint">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∫–∞—Ä—Ç—ã (.txt)</div>
                </div>

                <div id="mapContainer" class="map-container">
                    <div id="noMap" class="no-map">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∫–∞—Ä—Ç—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
                </div>

                <div class="status" id="status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã...</div>
            </div>

            <div class="control-section">
                <div class="commands">
                    <h3>–ö–æ–º–∞–Ω–¥—ã:</h3>
                    <textarea id="commandInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)"></textarea>

                    <div class="speed-control">
                        <label>–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏: <span id="delayLabel">0.00 s</span></label>
                        <input type="range" id="delayRange" min="0" max="2000" step="100" value="0">
                        <div class="speed-hint">0 ms ‚Äî –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏, 2000 ms ‚Äî –º–µ–¥–ª–µ–Ω–Ω–æ</div>
                    </div>

                    <div class="buttons">
                        <button id="runBtn">‚ñ∂ –í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                        <button id="resetBtn">‚ü≥ –°–±—Ä–æ—Å–∏—Ç—å</button>
                        <button id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <div class="legend">
                    <h3>–õ–µ–≥–µ–Ω–¥–∞</h3>
                    <div class="legend-items">
                        <div class="legend-item"><div class="legend-color path"></div><span>–ü—É—Ç—å (P)</span></div>
                        <div class="legend-item"><div class="legend-color ore"></div><span>–†—É–¥–∞ (O)</span></div>
                        <div class="legend-item"><div class="legend-color processed"></div><span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ (‚úì)</span></div>
                        <div class="legend-item"><div class="legend-color shaft"></div><span>–ó–∞–±–æ–π (#)</span></div>
                        <div class="legend-item"><div class="legend-color danger"></div><span>–û–ø–∞—Å–Ω–æ (!)</span></div>
                        <div class="legend-item"><div class="legend-color finish"></div><span>–§–∏–Ω–∏—à (F)</span></div>
                        <div class="legend-item"><div class="legend-robot">ü§ñ</div><span>–†–æ–±–æ—Ç</span></div>
                    </div>
                </div>

                <div class="command-examples">
                    <strong>–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥:</strong>
                    <div>–ò–¥—Ç–∏–ú–∏–Ω - –≤–ø–µ—Ä–µ–¥</div>
                    <div>–û—Ç–æ–π—Ç–∏–ú–∏–Ω - –Ω–∞–∑–∞–¥</div>
                    <div>–°–º–µ—Å—Ç–∏—Ç—å—Å—è–í–ª–µ–≤–æ/–í–ø—Ä–∞–≤–æ</div>
                    <div>–ü–æ–¥–Ω—è—Ç—å—Å—è/–°–ø—É—Å—Ç–∏—Ç—å—Å—è</div>
                    <div>–†—É–¥–∞ - –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä—É–¥—É</div>
                    <div>–ü—É—Ç—å - —Å–æ–∑–¥–∞—Ç—å —Ä—É–¥—É</div>
                </div>
            </div>
        </div>
    </div>

<script>

let currentSid = null;
let pollingId = null;
let isRunning = false;

const statusEl = () => document.getElementById('status');
const delayRange = document.getElementById('delayRange');
const delayLabel = document.getElementById('delayLabel');

function setSidToUrl(sid) {
    try {
        const newUrl = `${window.location.pathname}?sid=${encodeURIComponent(sid)}`;
        window.history.replaceState(null, '', newUrl);
    } catch (e) { console.warn(e); }
}

function getSidFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('sid');
}


(function(){
    const sid = getSidFromUrl();
    if (sid) {
        currentSid = sid;
        statusEl().textContent = 'SID –≤ URL, –∑–∞–≥—Ä—É–∂–∞—é –∫–∞—Ä—Ç—É...';
        loadMap();
    }
})();


delayRange.addEventListener('input', () => {
    delayLabel.textContent = (Number(delayRange.value)/1000).toFixed(2) + ' s';
});


document.getElementById('mapFile').addEventListener('change', async function () {
    const f = this.files[0];
    if (!f) return;
    statusEl().textContent = '–ó–∞–≥—Ä—É–∂–∞—é –∫–∞—Ä—Ç—É...';
    const fd = new FormData();
    fd.append('file', f);
    try {
        const resp = await fetch('/upload_map', { method: 'POST', body: fd });
        let data = null;
        try { data = await resp.json(); } catch (e) { statusEl().textContent = '–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON'; return; }
        if (!resp.ok || data.error) {
            statusEl().textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || resp.status);
            return;
        }
        currentSid = data.sid;
        setSidToUrl(currentSid);
        statusEl().textContent = `–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${data.width}x${data.height}`;
        loadMap();
    } catch (e) {
        console.error(e);
        statusEl().textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message;
    }
});


async function loadMap() {
    if (!currentSid) {
        statusEl().textContent = '–ù–µ—Ç SID';
        return;
    }
    try {
        const resp = await fetch(`/get_maze?sid=${currentSid}`);
        const data = await resp.json();
        if (data.error) { statusEl().textContent = data.error; return; }
        renderMap(data);
        statusEl().textContent = `–ö–∞—Ä—Ç–∞: ${data.width}x${data.height}`;
    } catch (e) {
        console.error(e);
        statusEl().textContent = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã';
    }
}


function renderMap(data) {
    const container = document.getElementById('mapContainer');
    container.innerHTML = '';
    const table = document.createElement('table');
    table.className = 'maze-table';

    for (let y = 0; y < data.height; y++) {
        const tr = document.createElement('tr');
        for (let x = 0; x < data.width; x++) {
            const cell = data.cells[y][x];
            const td = document.createElement('td');
            let className = 'cell ';
            let symbol = '';

            switch(cell.type) {
                case 0: className += 'path'; symbol = 'P'; break;
                case 1: className += 'ore'; symbol = 'O'; break;
                case 2: className += 'processed'; symbol = '‚úì'; break;
                case 3: className += 'shaft'; symbol = '#'; break;
                case 4: className += 'danger'; symbol = '!'; break;
                case 5: className += 'finish'; symbol = 'F'; break;
                default: className += 'path'; symbol = 'P';
            }
            if (cell.has_robot) { className += ' robot'; symbol = 'ü§ñ'; }

            td.className = className;
            td.title = `${cell.type_name} (${x}, ${y})${cell.has_robot ? ' - –†–æ–±–æ—Ç' : ''}`;
            td.textContent = symbol;
            tr.appendChild(td);
        }
        table.appendChild(tr);
    }

    container.appendChild(table);
}


function startPolling() {
    if (pollingId) clearInterval(pollingId);
    pollingId = setInterval(async () => {
        if (!currentSid) return;
        try {
            const st = await (await fetch(`/run_status?sid=${currentSid}`)).json();
            if (st.last_error) {
                statusEl().textContent = '–û—à–∏–±–∫–∞: ' + st.last_error;
            }

            const m = await (await fetch(`/get_maze?sid=${currentSid}`)).json();
            if (!m.error && m.cells) renderMap(m);

            if (!st.running) {

                clearInterval(pollingId);
                pollingId = null;
                isRunning = false;
                document.getElementById('runBtn').disabled = false;
                if (st.last_error) statusEl().textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å –æ—à–∏–±–∫–æ–π';
                else statusEl().textContent = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
            } else {
                statusEl().textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
            }
        } catch (e) {
            console.error('poll error', e);
        }
    }, 300);
}


function stopPolling() {
    if (pollingId) clearInterval(pollingId);
    pollingId = null;
}


document.getElementById('runBtn').addEventListener('click', async () => {
    if (isRunning) return;
    if (!currentSid) currentSid = getSidFromUrl();
    if (!currentSid) { statusEl().textContent = '–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç—É'; return; }

    const commands = document.getElementById('commandInput').value.trim();
    if (!commands) { statusEl().textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã'; return; }

    isRunning = true;
    document.getElementById('runBtn').disabled = true;
    statusEl().textContent = '–ó–∞–ø—É—Å–∫–∞—é...';

    const delaySec = Number(delayRange.value) / 1000.0;

    try {
        const resp = await fetch('/run_commands', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sid: currentSid, commands: commands, delay: delaySec })
        });
        const data = await resp.json();
        if (resp.status === 202 || (data && data.started)) {
            startPolling();
        } else {
            if (data.error) statusEl().textContent = '–û—à–∏–±–∫–∞: ' + data.error;
            else statusEl().textContent = '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞';
            isRunning = false;
            document.getElementById('runBtn').disabled = false;
        }
    } catch (e) {
        console.error(e);
        statusEl().textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞';
        isRunning = false;
        document.getElementById('runBtn').disabled = false;
    }
});


document.getElementById('resetBtn').addEventListener('click', async () => {
    if (!currentSid) currentSid = getSidFromUrl();
    if (!currentSid) { statusEl().textContent = '–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç—É'; return; }

    try {
        const resp = await fetch('/reset_maze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sid: currentSid })
        });
        const data = await resp.json();
        if (data.error) statusEl().textContent = '–û—à–∏–±–∫–∞: ' + data.error;
        else {
            renderMap(data);
            statusEl().textContent = '–ö–∞—Ä—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–∞';
        }
    } catch (e) {
        console.error(e);
        statusEl().textContent = '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞';
    }
});


document.getElementById('clearBtn').addEventListener('click', () => {
    document.getElementById('commandInput').value = '';
    statusEl().textContent = '–ö–æ–º–∞–Ω–¥—ã –æ—á–∏—â–µ–Ω—ã';
});
</script>
</body>
</html>
